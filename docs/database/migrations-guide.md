# Руководство по миграциям базы данных

## Обзор

Это руководство объясняет, как правильно управлять миграциями базы данных с помощью команд Prisma CLI. Все миграции должны выполняться через терминал, а не через API endpoints.

## Предварительные требования

- Установленный Prisma CLI: `bunx prisma --version`
- Настроенное подключение к базе данных в `.env`
- Схема Prisma расположена в `src/infrastructure/database/schema/schema.prisma`

## Структура проекта

```
src/infrastructure/database/schema/
├── schema.prisma                    # Основная схема Prisma
├── migrations/                      # Папка с миграциями
├── models/                         # Модели данных
└── enums/                          # Перечисления

backlog/migration/                   # Компоненты для будущего API миграций
├── migrations.controller.ts
├── migrations.service.ts
├── migrations-swagger.decorator.ts
└── create-migration.dto.ts
```

## Рабочий процесс миграций

### 1. Рабочий процесс разработки

Когда вы вносите изменения в схему Prisma (модели, перечисления, связи), следуйте этим шагам:

#### Шаг 1: Создание миграции

```bash
# Создать новую миграцию с описательным именем
bunx prisma migrate dev --name descriptive_migration_name

# Пример:
bunx prisma migrate dev --name add_user_profile_fields
```

Эта команда:

- Обнаруживает изменения схемы
- Создает новый файл миграции в `prisma/migrations/`
- Применяет миграцию к вашей базе данных разработки
- Регенерирует Prisma клиент

#### Шаг 2: Проверка миграции

Проверьте сгенерированный файл миграции в `prisma/migrations/[timestamp]_descriptive_migration_name.sql`, чтобы убедиться, что он соответствует вашим ожиданиям.

#### Шаг 3: Тестирование изменений

Запустите ваше приложение и протестируйте новую функциональность, чтобы убедиться, что все работает корректно.

### 2. Развертывание в продакшене

Для развертывания в продакшене используйте команду deploy:

```bash
# Применить ожидающие миграции к продакшен базе данных
bunx prisma migrate deploy
```

Эта команда:

- Применяет только ожидающие миграции (не создает новые)
- Безопасна для продакшен сред
- Не запрашивает пользовательский ввод

### 3. Сброс базы данных (только для разработки)

Если вам нужно полностью сбросить базу данных разработки:

```bash
# Сбросить базу данных и применить все миграции
bunx prisma migrate reset

# Принудительный сброс (пропускает подтверждение)
bunx prisma migrate reset --force
```

⚠️ **Предупреждение**: Это удалит все данные в вашей базе данных разработки!

### 4. Push схемы (альтернатива для разработки)

Для быстрых изменений схемы во время разработки можно использовать:

```bash
# Отправить изменения схемы напрямую в базу данных
bunx prisma db push
```

⚠️ **Примечание**: Это не создает файлы миграций и должно использоваться только во время разработки.

## Распространенные сценарии миграций

### Добавление новой модели

1. Добавьте модель в файл схемы
2. Выполните: `bunx prisma migrate dev --name add_new_model`
3. Протестируйте функциональность новой модели

### Изменение существующих моделей

1. Обновите модель в файле схемы
2. Выполните: `bunx prisma migrate dev --name modify_existing_model`
3. Проверьте сгенерированную миграцию
4. Протестируйте изменения

### Добавление/изменение перечислений

1. Обновите перечисление в файле схемы
2. Выполните: `bunx prisma migrate dev --name update_enum_values`
3. Протестируйте использование перечисления в приложении

### Добавление индексов или ограничений

1. Добавьте индексы/ограничения к вашим моделям
2. Выполните: `bunx prisma migrate dev --name add_indexes_constraints`
3. Проверьте улучшения производительности

## Структура файлов миграций

Файлы миграций расположены в `prisma/migrations/` и следуют соглашению об именовании:

```
[timestamp]_[migration_name].sql
```

Пример: `20250818054143_init.sql`

## Устранение неполадок

### Конфликты миграций

Если вы столкнулись с конфликтами миграций:

1. **Проверьте историю миграций**: `bunx prisma migrate status`
2. **Сбросьте при необходимости**: `bunx prisma migrate reset --force`
3. **Пересоздайте миграции**: Удалите файлы миграций и выполните `bunx prisma migrate dev --name init`

### Расхождение схемы

Если схема вашей базы данных не соответствует схеме Prisma:

1. **Проверьте расхождение**: `bunx prisma migrate diff --from-schema-datamodel prisma/schema.prisma --to-schema-datasource prisma/schema.prisma`
2. **Сбросьте при необходимости**: `bunx prisma migrate reset --force`

### Проблемы с генерацией клиента

Если вы столкнулись с ошибками TypeScript, связанными с Prisma клиентом:

```bash
# Регенерировать Prisma клиент
bunx prisma generate
```

## Лучшие практики

1. **Всегда используйте описательные имена миграций**, которые объясняют, что делает миграция
2. **Тестируйте миграции локально** перед применением в продакшене
3. **Проверяйте сгенерированные файлы миграций**, чтобы убедиться, что они соответствуют вашим ожиданиям
4. **Держите миграции маленькими и сфокусированными** - одно логическое изменение на миграцию
5. **Никогда не редактируйте существующие файлы миграций**, которые были применены в продакшене
6. **Делайте резервную копию продакшен базы данных** перед применением миграций
7. **Используйте `migrate deploy` для продакшена**, никогда `migrate dev`

## Справочник команд миграций

| Команда                 | Описание                                 | Применение            |
| ----------------------- | ---------------------------------------- | --------------------- |
| `prisma migrate dev`    | Создать и применить новую миграцию       | Разработка            |
| `prisma migrate deploy` | Применить ожидающие миграции             | Продакшен             |
| `prisma migrate reset`  | Сбросить БД и переприменить все миграции | Разработка            |
| `prisma migrate status` | Проверить статус миграций                | Отладка               |
| `prisma migrate diff`   | Сравнить различия схем                   | Отладка               |
| `prisma db push`        | Отправить схему напрямую в БД            | Только разработка     |
| `prisma generate`       | Регенерировать Prisma клиент             | После изменений схемы |

## Примечания по средам

### Разработка

- Используйте `migrate dev` для создания новых миграций
- Используйте `db push` для быстрых изменений схемы
- Не стесняйтесь сбрасывать базу данных при необходимости

### Стейджинг

- Используйте `migrate deploy` для применения миграций
- Тестируйте миграции перед развертыванием в продакшене

### Продакшен

- **Используйте только `migrate deploy`**
- Никогда не используйте `migrate dev` или `db push`
- Всегда делайте резервную копию базы данных перед миграциями
- Сначала тестируйте миграции в стейджинге
